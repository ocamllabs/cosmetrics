#!/bin/bash

echo "Making a list of all Mirage repositories"

CURRENT_DIR=`pwd`
DIR=`mktemp --directory ocaml-metrics-XXXX`
#echo "Using temporary directory $DIR"
cd $DIR
git clone https://github.com/mirage/megamirage.git
cd megamirage

ML="$CURRENT_DIR/src/mirage_repo.ml"
echo "(* Auto generated by $0 on `date`. *)" > $ML
echo "let all = [" >> $ML

# Extract URLs of submodules reporitories
IFS=$'\n'
for l in `git submodule init`; do
    URL=$(echo "$l" | sed -e 's/^[^(]*(\([^)]\+\)).*/\1/')
    # Change https into git (https://github.com/mirage/irmin/issues/244)
    URL=$(echo "$URL" | sed -e 's/https\?:/git:/')
    echo "  \"${URL%.git}.git\";" >> $ML
done
echo "]" >> $ML
echo "Wrote $ML"

cd "$CURRENT_DIR"
rm -rf $DIR
